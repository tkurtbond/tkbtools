#! /usr/bin/env bash

THREADS=1                       # Default is to use one thread.
DO_HELP=0                       # Does the help need to be displayed?
errors=0

while getopts "ht:" opt
do
    case "$opt" in
        (\?) ((errors++)) ;;
        (h) DO_HELP=1 ;;
        (t) THREADS=$OPTARG ;;
    esac
done

((DO_HELP)) && HELPOUT=/dev/stdout || HELPOUT=/dev/stderr

((DO_HELP || errors)) && {
    cat >$HELPOUT <<EOF
usage: $0 [-tn]

Options
-h      Displays this message.
-tn	Sets the number of threads to use.  Default: 1.
EOF
    exit
}

{
    echo "command line: $@"

    shift $((OPTIND-1))

    TESTFILE=$1

    time {
        echo "==== sha512sum $TESTFILE >T$THREADS-$TESTFILE.sha512sum"
        time sha512sum $TESTFILE >T$THREADS-$TESTFILE.sha512sum
        
        echo "==== xz --compress --threads=$THREADS <$TESTFILE >T$THREADS-$TESTFILE.xz at $(date -Iseconds)"
        ls -l $TESTFILE
        ls -lh $TESTFILE
        time xz --compress --threads=$THREADS <$TESTFILE >T$THREADS-$TESTFILE.xz
        ls -l T$THREADS-$TESTFILE.xz
        ls -lh T$THREADS-$TESTFILE.xz
        echo "==== xz --decompress <$TESTFILE >T$THREADS-$TESTFILE.c2 at $(date -Iseconds)"
        time xz --decompress <$TESTFILE.xz >T$THREADS-$TESTFILE.c2
        echo "sha512sum T$THREADS-$TESTFILE.c2 >T$THREADS-$TESTFILE.c2.sha512sum"
        time sha512sum T$THREADS-$TESTFILE.c2 >$TESTFILE.c2.sha512sum
        diff $TESTFILE.sha512sum T$THREADS-$TESTFILE.c2.sha512sum

        echo "==== zstd --threads=$THREADS  -19 <$TESTFILE >T$THREADS-$TESTFILE.zstd at $(date -Iseconds)"
        time zstd --threads=$THREADS -19 <$TESTFILE >T$THREADS-$TESTFILE.zstd
        ls -l T$THREADS-$TESTFILE.zstd
        ls -lh T$THREADS-$TESTFILE.zstd
        echo "==== zstd -d <T$THREADS-$TESTFILE.zstd >T$THREADS-$TESTFILE.c3 at $(date -Iseconds)"
        time zstd -d <T$THREADS-$TESTFILE.zstd >T$THREADS-$TESTFILE.c3
        echo "==== sha512sum T$THREADS-$TESTFILE.c3 >T$THREADS-$TESTFILE.c3.sha512sum"
        time sha512sum T$THREADS-$TESTFILE.c3 >T$THREADS-$TESTFILE.c3.sha512sum
        echo "==== Diffing $TESTFILE.sha512sum and T$THREADS-$TESTFILE.C3.sha512sum"
        diff $TESTFILE.sha512sum T$THREADS-$TESTFILE.c3.sha512sum
        echo "==== Done at $(date -Iseconds)"
    }
} 2>&1 | log compare-xz-zstd
